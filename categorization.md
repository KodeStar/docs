# Categorization

> The Category Module first appeared in Vanilo v0.4.

## Overview

Depending on your needs you may want to have a single category tree, or
more than one. As an example some shops prefer to have "brands" as a
hierarchical tree besides the usual "category" classification. Some
other shops use brand as a product attribute. Both solutions can be good
depending on the unique shop's needs.

Another example is a wine shop that classifies wines based on region and
on type.

Taken from other ecommerce systems, separate category trees are called
**Taxonomies** and their child branches are called **Taxons**.

**Example 1:**

```
Category                <- Taxonomy
│
├─> Men                 <- Taxon
│   └> T-shirts         <- Taxon
│   └> Jeans            <- Taxon
└─> Women               <- Taxon
    └> Skirts           <- Taxon
    └> Accessories      <- Taxon
```

**Example 2:**

```
Region                  <- Taxonomy
│
├─> France              <- Taxon
│   └> Bordeaux         <- Taxon
│   └> Côtes du Rhone   <- Taxon
└─> Italy               <- Taxon
    └> Veneto           <- Taxon
    └> Tuscany          <- Taxon
    └> Piedmont         <- Taxon
```

**Example 3:**

```
Type                    <- Taxonomy
│
├─> Red                 <- Taxon
│   └> Cabernet Franc   <- Taxon
│   └> Merlot           <- Taxon
│   └> Porto            <- Taxon
├─> White               <- Taxon
│   └> Muscat Ottonel   <- Taxon
│   └> Tokaji           <- Taxon
│   └> Furmint          <- Taxon
└─> Rosé                <- Taxon
    └> Cabernet Franc   <- Taxon
    └> Cuvée            <- Taxon
```

## Creating Taxonomies

Taxonomies basically have two properties: name and slug.
The slug must be unique and gets autogenerated (URL-ified) from the name
if it doesn't explicitly get specified.

```php
use Vanilo\Category\Models\Taxonomy;

$category = Taxonomy::create(['name' => 'Wine Regions']);

echo $category->name;
// Wine Regions
echo $category->slug;
// wine-regions
```

> The Taxonomy and the Taxon models use the
> [Eloquent Sluggable](https://github.com/cviebrock/eloquent-sluggable)
> package.

If you explicitly set the slug, no autogeneration will take place:

```php
use Vanilo\Category\Models\Taxonomy;

$category = Taxonomy::create(['name' => 'Wine Regions', 'slug' => 'regions']);

echo $category->slug;
// regions
```

In case a slug already exists, the slug will be automatically extended
to prevent duplicates:

```php
use Vanilo\Category\Models\Taxonomy;

$category1 = Taxonomy::create(['name' => 'Category']);
$category2 = Taxonomy::create(['name' => 'Category']);

echo $category1->slug;
// category

echo $category2->slug;
// category-1
```

## Creating Taxons

Taxons are the actual category entries like "Smartphones" or "Riesling",
etc. Every Taxon must belong to a Taxonomy and must have a name.

```php
use Vanilo\Category\Models\Taxonomy;
use Vanilo\Category\Models\Taxon;

$category = Taxonomy::create(['name' => 'Category']);
$smartphones = Taxon::create([
    'taxonomy_id' => $category->id,
    'name' => 'Smartphones'
]);

// You can also use the setTaxonomy method:
$smartphones->setTaxonomy($category);
$smartphones->save();
```

To retrieve the taxonomy the taxon belongs to, use the `taxonomy` property:

```php
$category = Taxonomy::create(['name' => 'Category']);

$taxon = new Taxon();
$taxon->setTaxonomy($category);

echo get_class($taxon->taxonomy);
// Vanilo\Category\Models\Taxonomy

echo $taxon->taxonomy->name;
// Category
```

### Taxon Slug (URL)

Taxons also have a slug field to be used for their URLs, and work very
similar to Taxonomies.

If no value is given for the `slug` field, it gets autogenerated from
the value of the name field:

```php
$category = Taxonomy::create(['name' => 'Category']);

$monitors = new Taxon();
$monitors->name = 'Monitors';
$monitors->setTaxonomy($category);
$monitors->save();

echo $monitors->slug;
// monitors
```

If you explicitly set the slug, no autogeneration will take place:

```php
$taxon = Taxon::create([
    'taxonomy_id' => Taxonomy::create(['name' => 'Wine Regions']),
    'name' => 'Carcavelos DOC',
    'slug' => 'carcavelos'
]);

echo $taxon->slug;
// carcavelos
```

Taxon slugs must be unique within the same taxonomy and level.

**Example of same slug allowed:**
```
wine-type               <- Taxonomy Slug
│
├─> red                 <- Taxon Slug
│   └> cabernet-franc   <- Taxon Slug, duplicate ✔
└─> rose                <- Taxon Slug
    └> cabernet-franc   <- Taxon Slug, duplicate ✔
```

**Example of same slug forbidden:**
```
wine-type               <- Taxonomy Slug
│
├─> red                 <- Taxon Slug
│   └> cabernet         <- Taxon Slug, duplicate ❌
│   └> cabernet         <- Taxon Slug, duplicate ❌
└─> rose                <- Taxon Slug
    └> cabernet         <- Taxon Slug, duplicate ✔
```

### Taxon Parents

Taxons can optionally have one parent taxon they belong under.
Taxons that don't have a parent taxon are considered root level entries.

```php
use Vanilo\Category\Models\Taxonomy;
use Vanilo\Category\Models\Taxon;

$category = Taxonomy::create(['name' => 'Category']);

$audio = Taxon::create([
    'taxonomy_id' => $category->id,
    'name' => 'Audio'
]);

$speakers = Taxon::create([
    'taxonomy_id' => $category->id,
    'parent_id' => $audio->id,
    'name' => 'Speakers'
]);

echo get_class($speakers->parent);
// Vanilo\Category\Models\Taxon
echo $speakers->parent->name;
// Audio
```

Other than setting the `parent_id` field directly, it is also possible to call the setter method:

```php
$childTaxon->setParent($parentTaxon);
$childTaxon->save();
```

To dissociate the parent use:

```php
$childTaxon->removeParent();
$childTaxon->save();

var_dump($childTaxon->parent_id);
// NULL
var_dump($childTaxon->parent);
// NULL
```

### Taxon Children

Since taxons are a tree type of hierarchy, they can have multiple children.

The `children` property returns a Collection of child taxons.

```php
$category = Taxonomy::create(['name' => 'Category']);

$topLevelTaxon = Taxon::create([
    'taxonomy_id' => $category->id,
    'name' => 'Rigging'    
]);

$childTaxon1 = Taxon::create([
    'taxonomy_id' => $category->id,
    'parent_id' => $topLevelTaxon->id,
    'name' => 'Halyards'
]);

$childTaxon1 = Taxon::create([
    'taxonomy_id' => $category->id,
    'parent_id' => $topLevelTaxon->id,
    'name' => 'Sheets'
]);

foreach ($topLevelTaxon->children as $child) {
    echo "{$child->name}\n";
}
// Halyards
// Sheets
```

### Taxon Level

Taxons can tell their level in the hierarchy.

Top level entries (without parent) are on level 0, their children are
level 1, and so on.

```php
$category = Taxonomy::create(['name' => 'Category']);

$audio = Taxon::create([
    'taxonomy_id' => $category->id,
    'name' => 'Audio'
]);

$speakers = Taxon::create([
    'taxonomy_id' => $category->id,
    'parent_id' => $audio->id,
    'name' => 'Speakers'
]);

echo $audio->level;
// 0

var_dump($audio->isRootLevel());
// true

echo $speakers->level;
// 1
```

## Known Issues

### Duplicate Taxon Slugs On Root Level

Uniqueness of taxon slugs within a taxonomy level is currently
guaranteed by unique DB keys. Most
[contemporary DB engines allow NULLs in composite unique keys](https://sqlite.org/faq.html#q26).

Therefore root level taxons can have duplicate slugs.


